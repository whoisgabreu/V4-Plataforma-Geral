<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hub de Projetos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="/static/style/home.css">

</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <div class="header-left">
            <img class="logo" src="/static/images/V4LOGO.png" alt="Logo">
            <div class="header-title">
                <h1>Hub de Projetos</h1>
                <span class="header-subtitle">Lisboa&CO TechOps</span>
            </div>
        </div>
        <div class="user-info">
            <div class="user-details">
                <div class="user-name">{{ session.nome }}</div>
                <div class="user-role">{{ session.funcao }} - {{ session.squad }}</div>
            </div>
            <button class="logout-btn" onclick="window.location.href='/logout'">
                <i class="fa-solid fa-right-from-bracket"></i> Sair
            </button>
        </div>
    </div>

    <!-- CONTE√öDO PRINCIPAL -->
    <div class="main-container">
        <div class="welcome-section">
            <h2>Bem-vindo, {{ session.nome.split()[0] }}! üëã</h2>
            <p>Gerencie seus projetos de forma centralizada</p>
        </div>

        <!-- TABS DE NAVEGA√á√ÉO -->
        <div class="tabs-container">
            <button class="tab-btn active" onclick="switchTab('ativos')">
                <i class="fa-solid fa-rocket"></i>
                Projetos Ativos
                <span class="tab-count">{{ projetos|length }}</span>
            </button>
            <button class="tab-btn" onclick="switchTab('onetime')">
                <i class="fa-solid fa-bolt"></i>
                One-Time
                <span class="tab-count">{{ projetos_onetime|length }}</span>
            </button>
            <button class="tab-btn" onclick="switchTab('inativos')">
                <i class="fa-solid fa-archive"></i>
                Inativos
                <span class="tab-count">{{ projetos_inativos|length }}</span>
            </button>
        </div>

        <!-- FILTROS -->
        <div class="filters">
            <div class="search-box">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" placeholder="Buscar projetos..." onkeyup="filterProjects()">
            </div>
        </div>

        <!-- CONTAINER DE SLIDES -->
        <div class="slides-wrapper">
            <!-- SLIDE ATIVOS -->
            <div class="slide-content active" id="slide-ativos">
                <div class="projects-grid">
                    {% if projetos %}
                        {% for projeto in projetos %}
                        <div class="project-card" 
                            data-projeto="{{ projeto.projetos.nome|lower }}"
                            data-projeto-json='{{ projeto.projetos|tojson|safe }}'
                            data-tipo="ativo"
                            onclick="openModalFromCard(this)">
                            <div class="project-header">
                                <div class="project-icon">
                                    <i class="fa-solid fa-folder-open"></i>
                                </div>
                                <span class="project-status status-ativo">Ativo</span>
                            </div>
                            <h3 class="project-title">{{ projeto.projetos.nome }}</h3>
                            <p class="project-description">
                                Squad: {{ projeto.projetos.squad_atribuida if projeto.projetos.squad_atribuida else 'N/A' }}
                            </p>
                            <div class="project-meta">
                                <span>
                                    <i class="fa-solid fa-calendar"></i>
                                    {{ projeto.projetos.data_de_inicio | format_date }}
                                </span>
                                <span>
                                    <i class="fa-solid fa-dollar-sign"></i>
                                    {{ projeto.projetos.fee }} {{ projeto.projetos.moeda }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fa-solid fa-inbox"></i>
                            <h3>Nenhum projeto ativo</h3>
                            <p>Voc√™ ainda n√£o est√° associado a nenhum projeto ativo</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- SLIDE ONETIME -->
            <div class="slide-content" id="slide-onetime">
                <div class="projects-grid">
                    {% if projetos_onetime %}
                        {% for projeto in projetos_onetime %}
                        <div class="project-card" 
                            data-projeto="{{ projeto.projetos.nome|lower }}"
                            data-projeto-json='{{ projeto.projetos|tojson|safe }}'
                            data-tipo="onetime"
                            onclick="openModalFromCard(this)">
                            <div class="project-header">
                                <div class="project-icon">
                                    <i class="fa-solid fa-bolt"></i>
                                </div>
                                <span class="project-status status-onetime">One-Time</span>
                            </div>
                            <h3 class="project-title">{{ projeto.projetos.nome }}</h3>
                            <p class="project-description">
                                Squad: {{ projeto.projetos.squad_atribuida if projeto.projetos.squad_atribuida else 'N/A' }}
                            </p>
                            <div class="project-meta">
                                <span>
                                    <i class="fa-solid fa-calendar"></i>
                                    {{ projeto.projetos.data_de_inicio | format_date }}
                                </span>
                                <span>
                                    <i class="fa-solid fa-dollar-sign"></i>
                                    {{ projeto.projetos.fee }} {{ projeto.projetos.moeda }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fa-solid fa-inbox"></i>
                            <h3>Nenhum projeto one-time</h3>
                            <p>Voc√™ ainda n√£o est√° associado a nenhum projeto one-time</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- SLIDE INATIVOS -->
            <div class="slide-content" id="slide-inativos">
                <div class="projects-grid">
                    {% if projetos_inativos %}
                        {% for projeto in projetos_inativos %}
                        <div class="project-card" 
                            data-projeto="{{ projeto.projetos.nome|lower }}"
                            data-projeto-json='{{ projeto.projetos|tojson|safe }}'
                            data-tipo="inativo"
                            onclick="openModalFromCard(this)">
                            <div class="project-header">
                                <div class="project-icon inactive">
                                    <i class="fa-solid fa-folder"></i>
                                </div>
                                <span class="project-status status-inativo">Inativo</span>
                            </div>
                            <h3 class="project-title">{{ projeto.projetos.nome }}</h3>
                            <p class="project-description">
                                Squad: {{ projeto.projetos.squad_atribuida if projeto.projetos.squad_atribuida else 'N/A' }}
                            </p>
                            <div class="project-meta">
                                <span>
                                    <i class="fa-solid fa-calendar"></i>
                                    {{ projeto.projetos.data_de_inicio | format_date }}
                                </span>
                                <span>
                                    <i class="fa-solid fa-dollar-sign"></i>
                                    {{ projeto.projetos.fee }} {{ projeto.projetos.moeda }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <i class="fa-solid fa-inbox"></i>
                            <h3>Nenhum projeto inativo</h3>
                            <p>Voc√™ ainda n√£o est√° associado a nenhum projeto inativo</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE DETALHES DO PROJETO -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Detalhes do Projeto</h2>
                <button class="close-btn" onclick="closeModal()">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <form id="projectForm" onsubmit="updateProject(event)">
                <div class="modal-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nome do Projeto</label>
                            <input type="text" name="nome" id="modal_nome" required>
                        </div>
                        
                        <div class="form-group">
                            <label>Pipefy ID</label>
                            <input type="text" name="pipefy_id" id="modal_pipefy_id">
                        </div>
                        
                        <div class="form-group">
                            <label>Documento</label>
                            <input type="text" name="documento" id="modal_documento">
                        </div>
                        
                        <div class="form-group">
                            <label>Fee</label>
                            <input type="number" name="fee" id="modal_fee">
                        </div>
                        
                        <div class="form-group">
                            <label>Moeda</label>
                            <select name="moeda" id="modal_moeda">
                                <option value="BRL">BRL</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Squad Atribu√≠da</label>
                            <input type="text" name="squad_atribuida" id="modal_squad">
                        </div>
                        
                        <div class="form-group">
                            <label>Produto Contratado</label>
                            <input type="text" name="produto_contratado" id="modal_produto">
                        </div>
                        
                        <div class="form-group">
                            <label>Data de In√≠cio</label>
                            <input type="date" name="data_de_inicio" id="modal_data_inicio">
                        </div>
                        
                        <div class="form-group">
                            <label>Cohort</label>
                            <input type="text" name="cohort" id="modal_cohort">
                        </div>
                        
                        <div class="form-group">
                            <label>Meta Account ID</label>
                            <input type="text" name="meta_account_id" id="modal_meta_account">
                        </div>
                        
                        <div class="form-group">
                            <label>Google Account ID</label>
                            <input type="text" name="google_account_id" id="modal_google_account">
                        </div>
                        
                        <div class="form-group">
                            <label>Fase do Pipefy</label>
                            <input type="text" name="fase_do_pipefy" id="modal_fase_pipefy">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>URL Webhook GChat</label>
                            <input type="url" name="url_webhook_gchat" id="modal_webhook_url">
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">
                        <i class="fa-solid fa-floppy-disk"></i> Salvar Altera√ß√µes
                    </button>
                </div>
                
                <input type="hidden" name="projeto_id" id="modal_projeto_id">
                <input type="hidden" name="tipo_projeto" id="modal_tipo_projeto">

            </form>
        </div>
    </div>

    <footer>
        <p>¬© 2025 TechOps ‚Äî Time de Tecnologia da Lisboa&CO. Transformando ideias em inova√ß√£o.</p>
    </footer>

    <script>
        let currentSlide = 'ativos';
        let currentProjectData = null;

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');
            
            document.querySelectorAll('.slide-content').forEach(slide => slide.classList.remove('active'));
            document.getElementById(`slide-${tab}`).classList.add('active');
            
            currentSlide = tab;
        }

        function filterProjects() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const activeSlide = document.querySelector('.slide-content.active');
            const cards = activeSlide.querySelectorAll('.project-card');
            
            cards.forEach(card => {
                const projectName = card.getAttribute('data-projeto');
                card.style.display = projectName.includes(searchValue) ? 'block' : 'none';
            });
        }

        function openModalFromCard(cardElement) {
            const projectData = JSON.parse(cardElement.getAttribute('data-projeto-json'));
            const tipoProjeto = cardElement.getAttribute('data-tipo');
            openModal(projectData, tipoProjeto);
        }

        function openModal(projectData, tipoProjeto) {
            currentProjectData = projectData;
            
            // Popular campos
            document.getElementById('modalTitle').textContent = projectData.nome;
            document.getElementById('modal_projeto_id').value = projectData.id;
            document.getElementById('modal_tipo_projeto').value = tipoProjeto; // NOVO
            document.getElementById('modal_nome').value = projectData.nome || '';
            document.getElementById('modal_pipefy_id').value = projectData.pipefy_id || '';
            document.getElementById('modal_documento').value = projectData.documento || '';
            document.getElementById('modal_fee').value = projectData.fee || '';
            document.getElementById('modal_moeda').value = projectData.moeda || 'BRL';
            document.getElementById('modal_squad').value = projectData.squad_atribuida || '';
            document.getElementById('modal_produto').value = projectData.produto_contratado || '';
            document.getElementById('modal_cohort').value = projectData.cohort || '';
            document.getElementById('modal_meta_account').value = projectData.meta_account_id || '';
            document.getElementById('modal_google_account').value = projectData.google_account_id || '';
            document.getElementById('modal_fase_pipefy').value = projectData.fase_do_pipefy || '';
            document.getElementById('modal_webhook_url').value = projectData.url_webhook_gchat || '';
            
            // Formatar data
            if (projectData.data_de_inicio) {
                const date = projectData.data_de_inicio.split('T')[0];
                document.getElementById('modal_data_inicio').value = date;
            }
            
            document.getElementById('projectModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            document.getElementById('projectModal').classList.remove('active');
            document.body.style.overflow = 'auto';
            currentProjectData = null;
        }

        async function updateProject(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch('https://n8n.v4lisboatech.com.br/webhook/update_projeto', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': '4815162342'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('Projeto atualizado com sucesso!');
                    closeModal();
                    location.reload();
                } else {
                    alert('Erro ao atualizar projeto');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao conectar com o servidor');
            }
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('projectModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>